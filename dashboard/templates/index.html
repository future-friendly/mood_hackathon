<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8"/>
        <title>Mood - Главная</title>
        <link rel="preconnect" href="https://fonts.gstatic.com">
        <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500&display=swap" rel="stylesheet">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
        <link rel="stylesheet" href="/static/css/main.css">
    </head>
    <body>
        <div id="app">
        <nav class="navbar navbar-expand-lg navbar-light" style="background-color: #fbf7d4;">
            <img src="/static/img/logo-small.png" style="height: 5rem;" class="navbar-brand">
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarColor01" aria-controls="navbarColor01" aria-expanded="false" aria-label="Toggle navigation">
              <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarColor01">
                <button class="btn btn-primary mx-2 my-2 my-sm-0" v-on:click="update">Обновить</button>
                <button class="btn btn-danger mx-2 my-2 my-sm-0" v-on:click="logout">Выйти</button>
            </div>
          </nav>
            <div id="notifications" class="my-3">
            </div>
        <div class="container-fluid mx-5" style="margin-top: 3rem; margin-bottom: 6rem;">
            <!-- Charts -->
            <div v-if="!noData">
                <h3>Категории контента</h3>
                <div class="row">
                    <div class="col">
                        <div class="card card-form" style="width: 22rem; height: 23rem;">
                            <div class="card-body">
                                <h5 class="card-title">График интересов</h5>
                                <canvas class="mt-5" id="interestChart"></canvas>
                            </div>
                            <div class="card-footer">
                                <button class="btn btn-primary" data-toggle="modal" data-target="#interestModal">Подробнее</button>
                            </div>
                        </div>
                    </div>
                    <div class="modal fade" id="interestModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLongTitle" aria-hidden="true">
                        <div class="modal-dialog" role="document">
                          <div class="modal-content">
                            <div class="modal-header">
                              <h5 class="modal-title" id="exampleModalLongTitle">Подробное описание</h5>
                              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                              </button>
                            </div>
                            <div class="modal-body">
                                <ul>
                                    <li v-for="(category, index) in interestChart.labels">
                                        {{ category }}: {{ interestChart.data[index] }}
                                    </li>
                                </ul>
                            </div>
                            <div class="modal-footer">
                              <button type="button" class="btn btn-secondary" data-dismiss="modal">Закрыть</button>
                            </div>
                          </div>
                        </div>
                      </div>
                </div>
                <h3 class="mt-5">Детализация категорий интересов</h3>
                <div class="row">
                    <div v-for="(chart, index) in keywordCharts">
                        <div class="col">
                            <div class="card card-form" style="width: 22rem; height: 23rem;">
                                <div class="card-body">
                                    <h5 class="card-title">{{ chart.data.category }}: ключевые слова</h5>
                                    <canvas class="mt-5" :id="chart.data.category"></canvas>
                                </div>
                                <div class="card-footer">
                                    <button class="btn btn-primary" data-toggle="modal" :data-target="'#keywordModal' + index">Подробнее</button>
                                </div>
                            </div>
                        </div>
                        <div class="modal fade" :id="'keywordModal' + index" tabindex="-1" role="dialog" aria-labelledby="exampleModalLongTitle" aria-hidden="true">
                            <div class="modal-dialog" role="document">
                              <div class="modal-content">
                                <div class="modal-header">
                                  <h5 class="modal-title" id="exampleModalLongTitle">Подробное описание</h5>
                                  <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                  </button>
                                </div>
                                <div class="modal-body">
                                    <ul>
                                        <li v-for="(category, index) in chart.data.full_labels">
                                            {{ category }}: {{ chart.data.full_data[index] }}
                                        </li>
                                    </ul>
                                </div>
                                <div class="modal-footer">
                                  <button type="button" class="btn btn-secondary" data-dismiss="modal">Закрыть</button>
                                </div>
                              </div>
                            </div>
                          </div>
                    </div>
                </div>
            </div>
            <!-- Agents -->
            <div class="mt-5">
                <h3>Мониторинговые агенты</h3>
                <p v-if="!agents.length">У вас нет подключенных мониторинговых агентов!</p>
                <div class="row">
                    <div v-for="agent in agents">
                        <div class="col my-3">
                            <div class="card" style="width: 22rem; height: 23rem;">
                                <div class="card-body">
                                    <h5 class="card-title">Агент: {{ agent.name }}</h5>
                                    <p class="card-text">Платформа: {{ agent.agent_type }}</p>
                                    <p class="alert alert-danger" v-if="!agent.confirmed">Агент оффлайн. Подключите его в расширении с этим токеном: <b>{{ agent.agent_token }}</b></p>
                                    <button class="btn btn-danger" v-on:click="deleteAgent(agent.ID)">Удалить</button>
                                </div>
                            </div>
                        </div>              
                    </div>
                    <!-- Add agent -->
                    <div class="col my-3">
                        <div class="card card-form" style="width: 22rem; height: 23rem;">
                            <div class="card-body">
                              <h5 class="card-title">Подключить новый агент</h5>
                              <div class="card-body">
                                <form @submit.prevent="addAgent">
                                    <div class="form-group">
                                        <label>Название</label>
                                        <input class="form-control" type="text" name="name" v-model="addAgent_name">
                                    </div>
                                    <div class="form-group">
                                        <label>Платформа</label>
                                        <select v-model="addAgent_type">
                                            <option v-for="option in options" v-bind:value="option.value">
                                            {{ option.text }}
                                            </option>
                                        </select>
                                    </div>
                                    <button class="btn btn-primary" type="submit">Add</button>
                                </form>
                              </div>
                            </div>
                        </div> 
                    </div> 
                </div>
            </div>
        </div>
        <footer style="padding: 1rem 0; color: #999; text-align: center; background-color: #fbf7d4; border-top: .05rem solid #e5e5e5;">
            <p><a href="https://fflab.co">Future Friendly</a> &copy; 2020</p>
        </footer>
        </div>
        <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx" crossorigin="anonymous"></script>
        
        <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

        <script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.4/dist/Chart.min.js"></script>
        <script>
            var chartColors = [ "#cce1f2", "#c7f8e5", "#fbf7d4", "#f9ded7", "#f6cddf", "#e3bef1", "#cce1f2", "#c7f8e5", "#fbf7d4", "#f9ded7", "#f6cddf", "#e3bef1", "#cce1f2", "#c7f8e5", "#fbf7d4", "#f9ded7", "#f6cddf", "#e3bef1", "#e3bef1", "#cce1f2", "#c7f8e5", "#fbf7d4", "#f9ded7", "#f6cddf", "#e3bef1"]
            
            function getRandomColor() {
                var letters = '0123456789ABCDEF';
                var color = '#';
                for (var i = 0; i < 6; i++) {
                    color += letters[Math.floor(Math.random() * 16)];
                }
                return color;
            }

            function handleError(error) {
                document.getElementById("notifications").innerHTML += `<div role="alert" class="alert alert-danger alert-dismissible fade show"><strong>Error occured: </strong> ${error}
                    <button type="button" data-dismiss="alert" aria-label="Close" class="close"><span aria-hidden="true">×</span></button></div>`
            }

            var app = new Vue({
                el: "#app",
                data: {
                    agents: [],
                    options: [
                        { text: 'Расширение Chrome', value: 0 },
                        { text: 'Android приложение', value: 1 },
                        { text: 'iOS приложение', value: 2 }
                    ],
                    addAgent_name: null,
                    addAgent_type: null,
                    interestChart: {
                        data: [],
                        labels: []
                    },
                    keywordCharts: [],
                    noData: false
                },
                mounted: function() {
                    this.getAgents()
                    this.getInterestChart(() => {
                        var ctx = document.getElementById("interestChart").getContext("2d")
                        new Chart(ctx, {
                            type: "doughnut",
                            data: {
                                labels: this.interestChart.labels,
                                datasets:[{
                                        data: this.interestChart.data,
                                        backgroundColor: chartColors
                                    }
                                ]
                            },
                            options: {
                                legend: {
                                    display: false
                                }
                            }
                        })
                        this.getKeywordCharts(() => {
                            setTimeout(() => {
                                ctxs = this.interestChart.labels.map(c => document.getElementById(c).getContext("2d"))
                                ctxs.map((ctx, index) => {
                                    new Chart(ctx, {
                                        type: "doughnut",
                                        data: {
                                            labels: this.keywordCharts[index].data.labels,
                                            datasets:[{
                                                    data: this.keywordCharts[index].data.data,
                                                    backgroundColor: chartColors
                                                }
                                            ]
                                        },
                                        options: {
                                            legend: {
                                                display: false
                                            }
                                        }
                                    })
                        }
                            )
                            } ,1000)
                        })
                    }
                    )
                },
                methods: {
                    getAgents: function() {
                        axios.get("/agents").then(response => (
                            this.agents = response.data.agents
                        ))
                    },
                    addAgent: function() {
                        axios.post("/newagent", {
                            name: this.addAgent_name,
                            agent_type: this.addAgent_type
                        }).then((response) => (
                            this.getAgents()
                        )).catch(function(error){
                            console.log(error)
                        })
                    },
                    deleteAgent: function(agentID){
                        axios.post("/deleteagent", {agent_id: agentID}).then((response) => (
                            this.getAgents()
                        )).catch(function(error){
                            console.log(error)
                        })
                    },
                    update: function() {
                        this.getInterestChart(() => {
                        var ctx = document.getElementById("interestChart").getContext("2d")
                        new Chart(ctx, {
                            type: "doughnut",
                            data: {
                                labels: this.interestChart.labels,
                                datasets:[{
                                        data: this.interestChart.data,
                                        backgroundColor: chartColors
                                    }
                                ]
                            },
                            options: {
                                legend: {
                                    display: false
                                }
                            }
                        })
                        this.getKeywordCharts(() => {
                            this.keywordCharts = []
                            setTimeout(() => {
                                ctxs = this.interestChart.labels.map(c => document.getElementById(c).getContext("2d"))
                                ctxs.map((ctx, index) => {
                                    new Chart(ctx, {
                                        type: "doughnut",
                                        data: {
                                            labels: this.keywordCharts[index].data.labels,
                                            datasets:[{
                                                    data: this.keywordCharts[index].data.data,
                                                    backgroundColor: chartColors
                                                }
                                            ]
                                        },
                                        options: {
                                            legend: {
                                                display: false
                                            }
                                        }
                                    })
                        }
                            )
                            } ,3000)
                        })
                    }
                    )
                    },
                    logout: function() {
                        axios.post("/logout").then(function(response){
                            window.location.replace("/login")
                        }).catch(function(error){
                            console.log(error)
                        })
                    },
                    getInterestChart: function(callback) {
                        axios.post("/interestmap").then((response) => {
                            if (!response.data.error) {
                                this.interestChart = response.data
                                callback()
                            } else {
                                handleError(response.data.error)
                            }
                        })
                    },
                    getKeywordCharts: function(callback) {
                        this.interestChart.labels.map(cat => (
                            axios.post("/keywordmap", {category:cat}).then(
                                (response) => {
                                    if (!response.data.error) {
                                        this.keywordCharts.push(response)
                                    } else {
                                        handleError(response.data.error)
                                    }
                                }
                            )
                            )
                        )
                        callback()
                    }
                }
            })
        </script>
    </body>
</html>